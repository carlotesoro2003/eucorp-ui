import{c as at,a as x,t as k}from"../chunks/disclose-version.CM6f1PTD.js";import{p as nt,g as t,f as st,a as lt,b as n,s as l,c as a,r as e,t as ot,d as C,i as H,n as xt}from"../chunks/runtime.g0my00JR.js";import{i as W}from"../chunks/if.DVEvk735.js";import{i as it}from"../chunks/lifecycle.6aQbxLMK.js";import{p as _t}from"../chunks/props.BjMJLEAs.js";import{s as g}from"../chunks/supabaseClient.CaMOPPuz.js";import{s as A}from"../chunks/render.pmuW5QOO.js";import{e as ct,i as ut}from"../chunks/each.BeKM084r.js";import{e as m}from"../chunks/utils.sCj8HAia.js";import{s as bt}from"../chunks/class.tYA33czU.js";import{o as ft}from"../chunks/index-client.v1G0sw0w.js";import{E as ht,a as gt}from"../chunks/jspdf.plugin.autotable.4s0l0uhg.js";import{r as yt}from"../chunks/attributes.BVavg5V5.js";import{r as tt}from"../chunks/misc.CY9ixZp3.js";import{b as N}from"../chunks/input.N22HgeA5.js";var wt=k('<div class="text-red-500 mb-4"> </div>'),kt=k('<span class="loading loading-spinner loading-sm">Loading...</span>'),Ot=k('<div class="text-center text-gray-500">No opportunities found.</div>'),Pt=k('<tr class="hover"><td class="px-4 py-2"> </td><td class="px-4 py-2"> </td><td class="px-4 py-2"> </td><td class="px-4 py-2"> </td><td class="px-4 py-2"> </td><td class="px-4 py-2"> </td><td class="px-4 py-2"> </td><td class="px-4 py-2 flex gap-2"><button class="btn bg-blue-600 hover:bg-blue-700 text-white font-medium">Edit</button> <button> </button> <button class="btn bg-red-600 hover:bg-red-700 text-white font-medium">Delete</button></td></tr>'),Et=k('<div class="overflow-x-auto"><table class="table table-zebra w-full"><thead><tr class="uppercase text-sm"><th class="px-4 py-2 text-left">Opportunity Statement</th><th class="px-4 py-2 text-left">Planned Actions</th><th class="px-4 py-2 text-left">KPI</th><th class="px-4 py-2 text-left">Key Persons</th><th class="px-4 py-2 text-left">Target Output</th><th class="px-4 py-2 text-left">Budget</th><th class="px-4 py-2 text-left">Department</th><th class="px-4 py-2 text-left">Actions</th></tr></thead><tbody></tbody></table></div>'),Tt=k('<div class="container mx-auto p-6"><h2 class="text-2xl  font-bold mb-6">My Opportunities</h2> <button class="btn btn-accent my-5">Export to PDF</button> <!> <!></div>');function At(Y,L){nt(L,!1);let y=C([]),O=C(!1),i=!1,h=null,p=C(null);const K=async()=>{const{data:{session:o},error:s}=await g.auth.getSession();if(s){console.error("Error fetching session:",s),n(p,"Session could not be retrieved."),setTimeout(()=>n(p,null),2e3);return}if(o){const{data:u,error:d}=await g.from("profiles").select("id").eq("id",o.user.id).single();d?(console.error("Error fetching profile:",d),n(p,"Failed to fetch profile information."),setTimeout(()=>n(p,null),2e3)):(h=u.id,S())}},S=async()=>{if(!h)return;n(O,!0);const{data:o,error:s}=await g.from("opportunities").select(`
                *,
                profiles (
                    department_id,
                    departments (name)
                )
            `);s?(console.error("Error fetching opportunities:",s),n(p,"Failed to load opportunities."),setTimeout(()=>n(p,null),2e3)):n(y,o.map(u=>{var d,b;return{...u,department_name:((b=(d=u.profiles)==null?void 0:d.departments)==null?void 0:b.name)||"N/A"}})),n(O,!1)},P=o=>{({...o})},w=async o=>{const{error:s}=await g.from("opportunities").delete().eq("id",o);s?(console.error("Error deleting opportunity:",s),n(p,"Failed to delete opportunity."),setTimeout(()=>n(p,null),2e3)):S()},_=async o=>{i=!0;try{const{error:s}=await g.from("opportunities").update({is_approved:!0}).eq("id",o.id);if(s){console.error("Error updating opportunity:",s),n(p,"Failed to approve opportunity."),setTimeout(()=>n(p,null),2e3),i=!1;return}const{error:u}=await g.from("opt_monitoring").insert({opt_id:o.id,profile_id:o.profile_id,is_accomplished:!1});u&&(console.error("Error inserting into opt_monitoring:",u),n(p,"Failed to add opportunity to monitoring."),setTimeout(()=>n(p,null),2e3)),S()}catch(s){console.error("Unexpected error:",s),n(p,"An unexpected error occurred."),setTimeout(()=>n(p,null),2e3)}finally{i=!1}},F=()=>{const o=new ht("landscape"),s=["Opportunity Statement","Planned Actions","KPI","Key Persons","Target Output","Budget","Department"],u=t(y).map(d=>[d.opt_statement,d.planned_actions,d.kpi,d.key_persons,d.target_output,d.budget.toString(),d.department_name]);o.text("Opportunities Report",14,10),gt(o,{head:[s],body:u,startY:20}),o.save("Opportunities_Report.pdf")};ft(()=>{K()}),it();var E=Tt(),D=l(a(E),2),T=l(D,2);W(T,()=>t(p),o=>{var s=wt(),u=a(s,!0);e(s),ot(()=>A(u,t(p))),x(o,s)});var et=l(T,2);W(et,()=>t(O),o=>{var s=kt();x(o,s)},o=>{var s=at(),u=st(s);W(u,()=>t(y).length===0,d=>{var b=Ot();x(d,b)},d=>{var b=Et(),f=a(b),r=l(a(f));ct(r,5,()=>t(y),ut,(M,c)=>{var R=Pt(),q=a(R),G=a(q,!0);e(q);var I=l(q),J=a(I,!0);e(I);var U=l(I),Q=a(U,!0);e(U);var $=l(U),V=a($,!0);e($);var B=l($),X=a(B,!0);e(B);var j=l(B),rt=a(j,!0);e(j);var Z=l(j),v=a(Z,!0);e(Z);var dt=l(Z),pt=a(dt),z=l(pt,2),vt=a(z,!0);e(z);var mt=l(z,2);e(dt),e(R),ot(()=>{A(G,t(c).opt_statement),A(J,t(c).planned_actions),A(Q,t(c).kpi),A(V,t(c).key_persons),A(X,t(c).target_output),A(rt,t(c).budget),A(v,t(c).department_name),bt(z,`btn text-white ${(t(c).is_approved?"bg-green-700 cursor-not-allowed":"btn-success")??""}`),z.disabled=t(c).is_approved,A(vt,t(c).is_approved?"Approved":"Approve")}),m("click",pt,()=>P(t(c))),m("click",z,()=>_(t(c))),m("click",mt,()=>w(t(c).id)),x(M,R)}),e(r),e(f),e(b),x(d,b)},!0),x(o,s)}),e(E),m("click",D,F),x(Y,E),lt()}var St=k('<tr><td class="px-4 py-2"><textarea placeholder="Opportunity Statement" class="textarea textarea-bordered w-full" style="overflow: hidden"></textarea></td><td class="px-4 py-2"><textarea placeholder="Planned Actions" class="textarea textarea-bordered w-full" style="overflow: hidden"></textarea></td><td class="px-4 py-2"><textarea placeholder="KPI" class="textarea textarea-bordered w-full" style="overflow: hidden"></textarea></td><td class="px-4 py-2"><textarea placeholder="Key Persons" class="textarea textarea-bordered w-full" style="overflow: hidden"></textarea></td><td class="px-4 py-2"><textarea placeholder="Target Output" class="textarea textarea-bordered w-full" style="overflow: hidden"></textarea></td><td class="px-4 py-2"><input type="number" placeholder="Budget" class="input input-bordered w-full"></td><td class="px-4 py-2"><button class="btn btn-sm btn-error">Delete</button></td></tr>'),Dt=k('<div class="container mx-auto p-6"><div class="p-6 rounded-lg shadow-lg mb-6"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold"></h2> <button class="btn btn-success">Save Progress</button></div> <div class="overflow-x-auto"><table class="table-auto table table-zebra w-full"><thead><tr class="text-sm"><th class="px-4 py-2 text-left">Opportunity Statement</th><th class="px-4 py-2 text-left">Planned Actions</th><th class="px-4 py-2 text-left">KPI</th><th class="px-4 py-2 text-left">Key Persons</th><th class="px-4 py-2 text-left">Target Output</th><th class="px-4 py-2 text-left">Budget</th><th class="px-4 py-2 text-left">Actions</th></tr></thead><tbody></tbody></table></div> <button class="btn btn-secondary mt-4">Add Row</button> <button class="btn btn-primary mt-4"></button></div></div>');function Kt(Y,L){nt(L,!1);let y=C(!1),O=!1,i=C([{opt_statement:"",planned_actions:"",kpi:"",key_persons:"",target_output:"",budget:0,profile_id:""}]),h=null;const p=async()=>{const{data:{session:f}}=await g.auth.getSession();if(f){const{data:r,error:M}=await g.from("profiles").select("id").eq("id",f.user.id).single();M?console.error("Error fetching profile:",M):h=r.id}else console.log("User is not logged in")},K=async()=>{if(!h)return;const{error:f}=await g.from("opportunities").insert(t(i).map(r=>({...r,profile_id:h})));f?console.error("Error creating opportunities:",f):(S(),n(i,[{opt_statement:"",planned_actions:"",kpi:"",key_persons:"",target_output:"",budget:0,profile_id:""}]))},S=async()=>{n(y,!0);const{data:f,error:r}=await g.from("opportunities").select("*").eq("profile_id",h);r&&console.error("Error fetching opportunities:",r),n(y,!1)},P=f=>{t(i).splice(f,1),n(i,[...t(i)])},w=()=>{n(i,[...t(i),{opt_statement:"",planned_actions:"",kpi:"",key_persons:"",target_output:"",budget:0,profile_id:""}])},_=f=>{const r=f.target;r.style.height="auto",r.style.width="auto",r.style.height=`${r.scrollHeight}px`,r.style.width=`${Math.max(r.scrollWidth,200)}px`};ft(()=>{p(),h&&S()}),it();var F=Dt(),E=a(F),D=a(E),T=a(D);T.textContent="Create Opportunity";var et=l(T,2);et.disabled=O,e(D);var o=l(D,2),s=a(o),u=l(a(s));ct(u,5,()=>t(i),ut,(f,r,M)=>{var c=St(),R=a(c),q=a(R);tt(q),e(R);var G=l(R),I=a(G);tt(I),e(G);var J=l(G),U=a(J);tt(U),e(J);var Q=l(J),$=a(Q);tt($),e(Q);var V=l(Q),B=a(V);tt(B),e(V);var X=l(V),j=a(X);yt(j),e(X);var rt=l(X),Z=a(rt);e(rt),e(c),N(q,()=>t(r).opt_statement,v=>(t(r).opt_statement=v,H(()=>t(i)))),m("input",q,_),N(I,()=>t(r).planned_actions,v=>(t(r).planned_actions=v,H(()=>t(i)))),m("input",I,_),N(U,()=>t(r).kpi,v=>(t(r).kpi=v,H(()=>t(i)))),m("input",U,_),N($,()=>t(r).key_persons,v=>(t(r).key_persons=v,H(()=>t(i)))),m("input",$,_),N(B,()=>t(r).target_output,v=>(t(r).target_output=v,H(()=>t(i)))),m("input",B,_),N(j,()=>t(r).budget,v=>(t(r).budget=v,H(()=>t(i)))),m("click",Z,()=>P(M)),x(f,c)}),e(u),e(s),e(o);var d=l(o,2),b=l(d,2);b.textContent="Submit Opportunities",e(E),e(F),ot(()=>b.disabled=t(y)),m("click",et,()=>console.log("Save Progress")),m("click",d,w),m("click",b,K),x(Y,F),lt()}var Ft=k('<span class="loading loading-spinner loading-sm"></span> <p class="text-white">Loading...</p>',1),Rt=k("<div><!></div>");function Jt(Y,L){nt(L,!1);let y=_t(L,"data",8);const{session:O}=y();let i=C(null),h=C(!0);(async()=>{if(O){const{user:P}=O,{data:w,error:_}=await g.from("profiles").select("role").eq("id",P.id).single();_?console.error("Error fetching user profile:",_.message):(n(i,w),console.log("Role in Opportunities: ",t(i)))}n(h,!1)})(),it();var K=Rt(),S=a(K);W(S,()=>t(h),P=>{var w=Ft();xt(2),x(P,w)},P=>{var w=at(),_=st(w);W(_,()=>O!==null&&t(i),F=>{var E=at(),D=st(E);W(D,()=>t(i).role==="admin",T=>{At(T,{})},T=>{Kt(T,{})}),x(F,E)},null,!0),x(P,w)}),e(K),x(Y,K),lt()}export{Jt as component};
