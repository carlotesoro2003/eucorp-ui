import{a as h,t as g,b as St,c as Ct}from"../chunks/disclose-version.CM6f1PTD.js";import{p as Nt,g as t,t as A,a as $t,b as n,c as i,r as o,s as l,i as G,d as k,f as _t}from"../chunks/runtime.g0my00JR.js";import{s as y}from"../chunks/render.pmuW5QOO.js";import{i as F}from"../chunks/if.DVEvk735.js";import{i as At}from"../chunks/lifecycle.6aQbxLMK.js";import{o as Et}from"../chunks/index-client.v1G0sw0w.js";import{s as R}from"../chunks/supabaseClient.CaMOPPuz.js";import{e as gt,i as pt}from"../chunks/each.BeKM084r.js";import{r as qt}from"../chunks/attributes.BVavg5V5.js";import{e as q}from"../chunks/utils.sCj8HAia.js";import{r as ht}from"../chunks/misc.CY9ixZp3.js";import{b as ct}from"../chunks/input.N22HgeA5.js";import{b as zt}from"../chunks/select.BRIlu2rr.js";import{g as It}from"../chunks/entry.CFewmVp1.js";import{E as Ut,a as Tt}from"../chunks/jspdf.plugin.autotable.4s0l0uhg.js";var Bt=g('<div class="alert alert-success shadow-lg mb-4"><span> </span></div>'),Kt=g('<div class="alert alert-error shadow-lg mb-4"><span> </span></div>'),jt=g("<option> </option>"),Ht=g('<tr><td style="width: 200px;"><input type="text" class="input input-bordered w-full" readonly=""></td><td><textarea class="textarea textarea-bordered w-full"></textarea></td><td style="width: 250px;"><select class="select select-bordered w-full"><option>Select classification</option><!></select></td><td><textarea class="textarea textarea-bordered w-full"></textarea></td><td><textarea class="textarea textarea-bordered w-full"></textarea></td><td><textarea class="textarea textarea-bordered w-full"></textarea></td><td><button class="btn btn-error">Remove</button></td></tr>'),Wt=g('<div class="text-center mt-6"><span class="loading loading-spinner"></span> Loading...</div>'),Yt=g('<div class="container mx-auto p-4"><h1 class="text-3xl font-bold mb-4"> </h1> <!> <!> <div class="overflow-x-auto"><table class="table table-zebra w-full"><thead><tr><th>RRN</th><th>Risk Statement</th><th>Classification</th><th>Actions</th><th>Key Persons</th><th>Budget</th><th>Remove</th></tr></thead><tbody></tbody></table></div> <div class="mt-4 flex gap-4"><button class="btn btn-primary">Add Row</button> <button class="btn btn-success">Save All</button> <button class="btn btn-secondary">Create Risk Assessment</button></div> <!></div>');function Gt(tt,rt){Nt(rt,!1);let v=k([]),N=k([]),S=null,_=null,z=k(""),w=k(!0),C=1,p=k(null),u=k(null);const I=async()=>{n(w,!0);try{const{data:r,error:a}=await R.auth.getSession();if(a)throw a;if(S=r.session,S){const{data:c,error:f}=await R.from("profiles").select("id, department_id").eq("id",S.user.id).single();if(f)throw f;_=c;const{data:x,error:$}=await R.from("departments").select("name").eq("id",_.department_id).single();if($)throw $;n(z,x.name),await b(),await D(),await U()}else n(u,"User is not logged in.")}catch(r){console.error("Error fetching user profile or department:",r),n(u,"Failed to fetch profile or department details.")}finally{n(w,!1)}},b=async()=>{n(w,!0);try{const{data:r,error:a}=await R.from("risks").select("*").eq("profile_id",_==null?void 0:_.id).order("rrn",{ascending:!0});if(a)throw a;n(v,r.sort((c,f)=>{const x=$=>{const m=$.match(/(\d+)$/);return m?parseInt(m[0],10):0};return x(c.rrn)-x(f.rrn)}))}catch(r){console.error("Error fetching risks:",r),n(u,"Failed to fetch risks.")}finally{n(w,!1)}},D=async()=>{try{const{data:r,error:a}=await R.from("risks").select("rrn").eq("profile_id",_==null?void 0:_.id).order("rrn",{ascending:!1}).limit(1);if(a)throw a;if(r.length>0){const f=r[0].rrn.match(/(\d+)$/);C=f?parseInt(f[0],10)+1:1}else C=1}catch(r){console.error("Error fetching next RRN number:",r),n(u,"Failed to determine the next RRN number.")}},U=async()=>{try{const{data:r,error:a}=await R.from("classification").select("id, name");if(a)throw a;n(N,r)}catch(r){console.error("Error fetching classifications:",r),n(u,"Failed to fetch classifications.")}},M=()=>{n(v,[...t(v),{rrn:`RRN-${t(z)}-${(C+=1)-1}`,risk_statement:"",classification:null,actions:"",key_persons:"",budget:0,profile_id:(_==null?void 0:_.id)||""}])},bt=r=>{t(v).length>0&&r===t(v).length-1&&(C-=1),n(v,t(v).filter((a,c)=>c!==r))},xt=async()=>{n(w,!0);try{const{error:r}=await R.from("risks").upsert(t(v),{onConflict:"rrn"});if(r)throw r;n(p,"Risks saved successfully!"),n(u,null),await b(),await D()}catch(r){console.error("Error saving risks:",r),n(p,null),n(u,"Failed to save risks.")}finally{n(w,!1)}},J=r=>{r.style.height="auto",r.style.width="auto",r.style.height=`${r.scrollHeight}px`,r.style.width=`${Math.max(300,r.scrollWidth)}px`};Et(()=>{I()}),At();var et=Yt(),O=i(et),dt=i(O);o(O);var at=l(O,2);F(at,()=>t(p),r=>{var a=Bt(),c=i(a),f=i(c,!0);o(c),o(a),A(()=>y(f,t(p))),h(r,a)});var st=l(at,2);F(st,()=>t(u),r=>{var a=Kt(),c=i(a),f=i(c,!0);o(c),o(a),A(()=>y(f,t(u))),h(r,a)});var T=l(st,2),vt=i(T),Q=l(i(vt));gt(Q,5,()=>t(v),pt,(r,a,c)=>{var f=Ht(),x=i(f),$=i(x);qt($),o(x);var m=l(x),P=i(m);ht(P),o(m);var K=l(m),ot=i(K);A(()=>{t(a).classification,G(()=>{t(N)})});var j=i(ot);j.value=(j.__value=null)==null?"":null;var yt=l(j);gt(yt,1,()=>t(N),pt,(d,X)=>{var E=jt(),L={},ut=i(E,!0);o(E),A(()=>{L!==(L=t(X).id)&&(E.value=(E.__value=t(X).id)==null?"":t(X).id),y(ut,t(X).name)}),h(d,E)}),o(ot),o(K);var H=l(K),it=i(H);ht(it),o(H);var W=l(H),nt=i(W);ht(nt),o(W);var Y=l(W),lt=i(Y);ht(lt),o(Y);var V=l(Y),Rt=i(V);o(V),o(f),ct($,()=>t(a).rrn,d=>(t(a).rrn=d,G(()=>t(v)))),ct(P,()=>t(a).risk_statement,d=>(t(a).risk_statement=d,G(()=>t(v)))),q("input",P,d=>J(d.target)),zt(ot,()=>t(a).classification,d=>(t(a).classification=d,G(()=>t(v)))),ct(it,()=>t(a).actions,d=>(t(a).actions=d,G(()=>t(v)))),q("input",it,d=>J(d.target)),ct(nt,()=>t(a).key_persons,d=>(t(a).key_persons=d,G(()=>t(v)))),q("input",nt,d=>J(d.target)),ct(lt,()=>t(a).budget,d=>(t(a).budget=d,G(()=>t(v)))),q("input",lt,d=>J(d.target)),q("click",Rt,()=>bt(c)),h(r,f)}),o(Q),o(vt),o(T);var B=l(T,2),ft=i(B),mt=l(ft,2),s=l(mt,2);o(B);var e=l(B,2);F(e,()=>t(w),r=>{var a=Wt();h(r,a)}),o(et),A(()=>y(dt,`${t(z)??""} Risks Register`)),q("click",ft,M),q("click",mt,xt),q("click",s,()=>It("/risks/riskAssessment")),h(tt,et),$t()}var Jt=g('<div class="text-center text-xl"><span class="loading loading-spinner loading-md"></span></div>'),Ot=g('<div class="alert alert-error"> </div>'),Qt=g('<div class="alert alert-success"></div>'),Vt=g("<div><strong>Likelihood:</strong> <br> <strong>Severity:</strong> <br> <strong>Control Rating:</strong> <br> <strong>Monitoring Rating:</strong> </div>"),Xt=g("<!> <!>",1),Zt=g("<tr><td> </td><td> </td><td> </td><td> </td><td> </td><td> </td><td><!></td></tr>"),tr=g('<!> <!> <div class="overflow-x-auto"><table class="table w-full table-zebra"><thead><tr><th>RRN</th><th>Risk Statement</th><th>Classification</th><th>Actions</th><th>Key Persons</th><th>Budget</th><th>Risk Assessments</th></tr></thead><tbody></tbody></table></div>',1),rr=g('<div class="container mx-auto my-6"><div class="mb-4"><button class="btn btn-primary">Export to PDF</button></div> <!></div>');function er(tt,rt){Nt(rt,!1);let v=k([]),N=k([]),S=[],_=[],z=[],w=[],C=[],p=k(!0),u=k(!0),I=null,b=k(null);const D=async()=>{n(p,!0);try{const{data:s,error:e}=await R.from("risks").select("*").order("rrn",{ascending:!0});if(e)throw e;n(v,s.sort((r,a)=>{const c=f=>{const x=f.match(/(\d+)$/);return x?parseInt(x[0],10):0};return c(r.rrn)-c(a.rrn)}))}catch(s){console.error("Error fetching risks:",s),n(b,"Failed to fetch risks.")}finally{n(p,!1)}},U=async()=>{try{const{data:s,error:e}=await R.from("classification").select("*");if(e)throw e;n(N,s)}catch(s){console.error("Error fetching classification:",s),n(b,"Failed to fetch classification.")}},M=async()=>{n(u,!0);try{const{data:s,error:e}=await R.from("risk_assessment").select("*");if(e)throw e;C=s}catch(s){console.error("Error fetching risk assessment:",s),n(b,"Failed to fetch risk assessment.")}finally{n(u,!1)}},bt=async()=>{const{data:s,error:e}=await R.from("likelihood_rating").select("*");e||(S=s)},xt=async()=>{const{data:s,error:e}=await R.from("severity").select("*");e||(_=s)},J=async()=>{const{data:s,error:e}=await R.from("risk_control_rating").select("*");e||(z=s)},et=async()=>{const{data:s,error:e}=await R.from("risk_monitoring_rating").select("*");e||(w=s)},O=s=>{var e;return((e=S.find(r=>r.id===s))==null?void 0:e.name)||"Not Available"},dt=s=>{var e;return((e=_.find(r=>r.id===s))==null?void 0:e.name)||"Not Available"},at=s=>{var e;return((e=z.find(r=>r.id===s))==null?void 0:e.name)||"Not Available"},st=s=>{var e;return((e=w.find(r=>r.id===s))==null?void 0:e.status)||"Not Available"},T=s=>C.filter(e=>e.risk_id===s),vt=()=>{const s=new Ut("landscape");s.setFontSize(12),s.text("Risk and Risk Assessment Data",14,15),Tt(s,{startY:20,head:[["RRN","Risk Statement","Classification","Likelihood","Severity","Control Rating","Monitoring Rating"]],body:t(v).flatMap(e=>{var a;const r=T(e.id);return r.length===0?[[e.rrn,e.risk_statement,((a=t(N).find(c=>c.id===e.classification))==null?void 0:a.name)||"N/A","No Data","No Data","No Data","No Data"]]:r.map(c=>{var f;return[e.rrn,e.risk_statement,((f=t(N).find(x=>x.id===e.classification))==null?void 0:f.name)||"N/A",O(c.lr),dt(c.s),at(c.rcr),st(c.rmr)]})})}),s.save("Risks_Assessment_Data.pdf")};Et(()=>{Promise.all([D(),U(),bt(),xt(),J(),et(),M()]).catch(s=>{console.error("Error fetching data:",s),n(b,"Failed to fetch some data.")})}),At();var Q=rr(),B=i(Q),ft=i(B);o(B);var mt=l(B,2);F(mt,()=>t(p),s=>{var e=Jt();h(s,e)},s=>{var e=tr(),r=_t(e);F(r,()=>t(b),$=>{var m=Ot(),P=i(m,!0);o(m),A(()=>y(P,t(b))),h($,m)});var a=l(r,2);F(a,()=>I,$=>{var m=Qt();m.textContent=I,h($,m)});var c=l(a,2),f=i(c),x=l(i(f));gt(x,5,()=>t(v),pt,($,m)=>{var P=Zt(),K=i(P),ot=i(K,!0);o(K);var j=l(K),yt=i(j,!0);o(j);var H=l(j),it=i(H,!0);A(()=>{var E;return y(it,((E=t(N).find(L=>L.id===t(m).classification))==null?void 0:E.name)||"N/A")}),o(H);var W=l(H),nt=i(W,!0);o(W);var Y=l(W),lt=i(Y,!0);o(Y);var V=l(Y),Rt=i(V);o(V);var d=l(V),X=i(d);F(X,()=>t(u),E=>{var L=St("Loading...");h(E,L)},E=>{var L=Xt(),ut=_t(L);gt(ut,1,()=>T(t(m).id),pt,(wt,Z)=>{var kt=Vt(),Dt=l(i(kt));A(()=>y(Dt,` ${O(t(Z).lr)??""} `));var Ft=l(Dt,4);A(()=>y(Ft,` ${dt(t(Z).s)??""} `));var Mt=l(Ft,4);A(()=>y(Mt,` ${at(t(Z).rcr)??""} `));var Lt=l(Mt,4);A(()=>y(Lt,` ${st(t(Z).rmr)??""}`)),o(kt),h(wt,kt)});var Pt=l(ut,2);F(Pt,()=>T(t(m).id).length===0,wt=>{var Z=St("No assessment data available.");h(wt,Z)}),h(E,L)}),o(d),o(P),A(()=>{y(ot,t(m).rrn),y(yt,t(m).risk_statement),y(nt,t(m).actions),y(lt,t(m).key_persons),y(Rt,`$${t(m).budget??""}`)}),h($,P)}),o(x),o(f),o(c),h(s,e)}),o(Q),q("click",ft,vt),h(tt,Q),$t()}var ar=g("<p>Loading...</p>"),sr=g('<p class="text-red-500"> </p>'),or=g("<div><!></div>");function yr(tt,rt){Nt(rt,!1);let v=null,N=k(null),S=k(!0),_=k(null);const z=async()=>{try{const{data:p,error:u}=await R.auth.getSession();if(u)throw u;if(v=p.session,v){const{data:I,error:b}=await R.from("profiles").select("*").eq("id",v.user.id).single();if(b)throw b;n(N,I),console.log("Profile Id: ",t(N).id),console.log("Profile Role: ",t(N).role)}else n(_,"User is not logged in.")}catch(p){console.error(p.message),n(_,"Failed to fetch profile data.")}finally{n(S,!1)}};Et(()=>{z()}),At();var w=or(),C=i(w);F(C,()=>t(S),p=>{var u=ar();h(p,u)},p=>{var u=Ct(),I=_t(u);F(I,()=>t(_),b=>{var D=sr(),U=i(D,!0);o(D),A(()=>y(U,t(_))),h(b,D)},b=>{var D=Ct(),U=_t(D);F(U,()=>{var M;return((M=t(N))==null?void 0:M.role)==="admin"},M=>{er(M,{})},M=>{Gt(M,{})}),h(b,D)},!0),h(p,u)}),o(w),h(tt,w),$t()}export{yr as component};
